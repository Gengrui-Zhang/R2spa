---
title: "tspa-plot-vignette"
author: "Jimmy Zhang"
date: "2023-02-16"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The example is from <https://lavaan.ugent.be/tutorial/sem.html>.

Load packages

```{r load-pkg, message = FALSE}
library(lavaan)
library(R2spa)
library(semdplot)
```

## Single group, single predictor

```{r}
model <- ' 
  # latent variable definitions
     ind60 =~ x1 + x2 + x3
     dem60 =~ y1 + a*y2 + b*y3 + c*y4

  # regressions
    dem60 ~ ind60
'

fs_dat_ind60 <- get_fs(data = PoliticalDemocracy, 
                       model = "ind60 =~ x1 + x2 + x3")
fs_dat_dem60 <- get_fs(data = PoliticalDemocracy, 
                       model = "dem60 =~ y1 + y2 + y3 + y4")
fs_dat <- cbind(fs_dat_ind60, fs_dat_dem60)

tspa_fit_1 <- tspa(model = "dem60 ~ ind60", 
                 data = fs_dat, 
                 se = list(ind60 = 0.1213615, dem60 = 0.6756472))
```

We recommend researchers to examine the diagnostic plot of factor scores in the model. They can use the function `tspa_plot()` to obtain two plots: (a) a scatter plot between factors, (b) a residual plot between factors.

Features of `tspa_plot()`:
- The function is able to pass arguments to the base R `plot()` function. 
- Users can define title of the scatter plot and label names of axis.
- Abbreviation argument allows users to choose whether using abbreviated group names.
- Users can choose whether generating the plot one by one by hitting the <return> on the keyboard.

```{r example_single_group_single_factor}
# par(mar = c(2,2,3,2))
tspa_plot(tspa_fit_1,
          col = "darkgray",
          cex.lab = 1.2,
          cex.axis = 1,
          ask = TRUE)
```

```{r example using casewise_residuals function}
casewise_residuals(tspa_fit_1)
```

It seems that `casewise_residuals` function does not support tspa model fits because they have latent variables.

## Single group, multiple predictors

```{r}
model <- ' 
  # latent variable definitions
     ind60 =~ x1 + x2 + x3
     dem60 =~ y1 + y2 + y3 + y4
     dem65 =~ y5 + y6 + y7 + y8

  # regressions
    dem60 ~ ind60
    dem65 ~ ind60 + dem60

  # # residual correlations
  #   y1 ~~ y5
  #   y2 ~~ y4 + y6
  #   y3 ~~ y7
  #   y4 ~~ y8
  #   y6 ~~ y8
'

fs_dat_ind60 <- get_fs(data = PoliticalDemocracy, 
                       model = "ind60 =~ x1 + x2 + x3")
fs_dat_dem60 <- get_fs(data = PoliticalDemocracy, 
                       model = "dem60 =~ y1 + y2 + y3 + y4")
fs_dat_dem65 <- get_fs(data = PoliticalDemocracy, 
                       model = "dem65 =~ y5 + y6 + y7 + y8")
fs_dat <- cbind(fs_dat_ind60, fs_dat_dem60, fs_dat_dem65)

tspa_3var_fit <- tspa(model = "dem60 ~ ind60
                          dem65 ~ ind60 + dem60", 
                      data = fs_dat, 
                      se = list(ind60 = 0.1213615, dem60 = 0.6756472, 
                                dem65 = 0.5724405))
```

```{r example_single_group_multiple_factors}
# Title, xlab, and ylab each with same names.
tspa_plot(tspa_3var_fit,
          ps = 10,
          col = "darkgray",
          cex.lab = 1.2,
          cex.axis = 1)

# Title, xlab, and ylab each with separate names.
tspa_plot(tspa_3var_fit,
          ps = 10,
          col = "darkgray",
          cex.lab = 1.2,
          cex.axis = 1,
          title = c("Scatterplot_I", "Scatterplot_II", "Scatterplot_III"),
          label_x = c("factor_1", "factor_2", "factor_3"),
          label_y = c("factor_a", "factor_b", "factor_c"))
```

## Multigroup, single predictor

```{r}
model <- ' 
  # latent variable definitions
    visual =~ x1 + x2 + x3
    speed =~ x7 + x8 + x9

  # regressions
    visual ~ speed
'

hs_mod <- '
visual =~ x1 + x2 + x3
speed =~ x7 + x8 + x9
'

# get factor scores
fs_dat_visual <- get_fs(data = HolzingerSwineford1939, 
                        model = "visual =~ x1 + x2 + x3", 
                        group = "school")
fs_dat_speed <- get_fs(data = HolzingerSwineford1939, 
                       model = "speed =~ x7 + x8 + x9", 
                        group = "school")
fs_hs <- cbind(fs_dat_visual, fs_dat_speed)

tspa_fit_3 <- tspa(model = "visual ~ speed",
                 data = fs_hs,
                 se = data.frame(visual = c(0.3391326, 0.311828),
                                 speed = c(0.2786875, 0.2740507)),
                 group = "school"
                 # group.equal = "regressions"
                 )
```

```{r example_multiple_group_single_factor}
par(mar = c(4,4,4,4))
tspa_plot(tspa_fit_3,
          ps = 10,
          col = "darkgray",
          cex.lab = 1.2,
          cex.axis = 1)

par(mar = c(4,4,4,4))
tspa_plot(tspa_fit_3,
          ps = 10,
          col = "darkgray",
          cex.lab = 1.2,
          cex.axis = 1,
          abbreviation = FALSE)
```

```{r}
fs_sem3 <- sem(model = "fs_visual ~ fs_speed",
               data = fs_hs)

fit_res3 <- casewise_residuals(fs_sem3)
p <- plot(fit_res3,
           x_names = c("fs_speed"),
           y_names = c("fs_visual"))

plot(p)
```






